name: Update Projects List

on:
  schedule:
    # Run every Sunday at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch: # Allow manual trigger

jobs:
  update-projects:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Search for projects with topic
        id: search
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Search for repos with uses-cc-initializer topic
          # Exclude the cc-initializer repo itself
          echo "Searching for projects with 'uses-cc-initializer' topic..."

          gh api graphql -f query='
            query {
              search(query: "topic:uses-cc-initializer", type: REPOSITORY, first: 100) {
                repositoryCount
                nodes {
                  ... on Repository {
                    nameWithOwner
                    description
                    url
                    stargazerCount
                    isPrivate
                    pushedAt
                  }
                }
              }
            }
          ' > topic_results.json

          echo "Found repositories:"
          cat topic_results.json

      - name: Generate projects list
        run: |
          # Read manual projects from PROJECTS.json
          MANUAL_PROJECTS=""
          if [ -f "PROJECTS.json" ]; then
            MANUAL_PROJECTS=$(cat PROJECTS.json)
          fi

          # Parse topic search results
          TOPIC_PROJECTS=$(cat topic_results.json)

          # Generate markdown using Python
          python3 << 'PYTHON_SCRIPT'
          import json
          import os
          from datetime import datetime

          # Read topic search results
          with open('topic_results.json', 'r') as f:
              topic_data = json.load(f)

          # Read manual projects
          manual_projects = []
          if os.path.exists('PROJECTS.json'):
              with open('PROJECTS.json', 'r') as f:
                  manual_data = json.load(f)
                  manual_projects = manual_data.get('projects', [])

          # Extract topic-discovered projects
          topic_projects = []
          if 'data' in topic_data and 'search' in topic_data['data']:
              nodes = topic_data['data']['search']['nodes']
              for repo in nodes:
                  if repo and not repo.get('isPrivate', True):
                      # Exclude cc-initializer itself
                      if 'cc-initializer' not in repo['nameWithOwner'].lower() or 'obsidian' in repo['nameWithOwner'].lower():
                          topic_projects.append({
                              'name': repo['nameWithOwner'],
                              'description': repo.get('description', 'No description'),
                              'url': repo['url'],
                              'stars': repo.get('stargazerCount', 0)
                          })

          # Sort by stars
          topic_projects.sort(key=lambda x: x['stars'], reverse=True)

          # Generate markdown
          md_lines = []

          if topic_projects or manual_projects:
              md_lines.append("## Projects Using cc-initializer")
              md_lines.append("")

              if topic_projects:
                  md_lines.append("### Auto-discovered")
                  md_lines.append("")
                  md_lines.append("| Project | Description | Stars |")
                  md_lines.append("|---------|-------------|:-----:|")
                  for p in topic_projects[:20]:  # Limit to top 20
                      desc = (p['description'] or 'No description')[:50]
                      if len(p['description'] or '') > 50:
                          desc += '...'
                      md_lines.append(f"| [{p['name']}]({p['url']}) | {desc} | {p['stars']} |")
                  md_lines.append("")

              if manual_projects:
                  md_lines.append("### Community Showcase")
                  md_lines.append("")
                  md_lines.append("| Project | Description |")
                  md_lines.append("|---------|-------------|")
                  for p in manual_projects:
                      md_lines.append(f"| [{p['name']}]({p['url']}) | {p.get('description', '')} |")
                  md_lines.append("")

              md_lines.append("> **Add your project**: Add `uses-cc-initializer` topic to your repo or [submit a PR](PROJECTS.json)")
              md_lines.append("")
              md_lines.append(f"_Last updated: {datetime.utcnow().strftime('%Y-%m-%d')}_")
              md_lines.append("")

          # Write to file
          with open('PROJECTS_SECTION.md', 'w') as f:
              f.write('\n'.join(md_lines))

          print("Generated PROJECTS_SECTION.md")
          print('\n'.join(md_lines))
          PYTHON_SCRIPT

      - name: Update README
        run: |
          # Check if PROJECTS_SECTION.md was generated
          if [ ! -f "PROJECTS_SECTION.md" ]; then
            echo "No projects section generated"
            exit 0
          fi

          # Check if section already exists
          if grep -q "## Projects Using cc-initializer" README.md; then
            # Replace existing section
            # Find the line numbers for the section
            python3 << 'PYTHON_SCRIPT'
          with open('README.md', 'r') as f:
              readme = f.read()

          with open('PROJECTS_SECTION.md', 'r') as f:
              projects_section = f.read()

          # Find and replace the projects section
          import re

          # Pattern to match the entire Projects section until the next ## or ---
          pattern = r'## Projects Using cc-initializer.*?(?=\n## |\n---|\Z)'

          if re.search(pattern, readme, re.DOTALL):
              # Replace existing section
              new_readme = re.sub(pattern, projects_section.strip(), readme, flags=re.DOTALL)
          else:
              # Insert after Quick Start section
              # Find the position after "## Quick Start" section
              quick_start_pattern = r'(## Quick Start.*?)(---)'
              match = re.search(quick_start_pattern, readme, re.DOTALL)
              if match:
                  insert_pos = match.end(1)
                  new_readme = readme[:insert_pos] + '\n' + projects_section + '\n' + readme[insert_pos:]
              else:
                  # Fallback: insert after first ---
                  first_hr = readme.find('---')
                  if first_hr != -1:
                      second_hr = readme.find('---', first_hr + 3)
                      if second_hr != -1:
                          new_readme = readme[:second_hr] + projects_section + '\n' + readme[second_hr:]
                      else:
                          new_readme = readme + '\n' + projects_section
                  else:
                      new_readme = readme + '\n' + projects_section

          with open('README.md', 'w') as f:
              f.write(new_readme)

          print("README.md updated")
          PYTHON_SCRIPT
          else
            # Insert new section after Quick Start
            python3 << 'PYTHON_SCRIPT'
          with open('README.md', 'r') as f:
              readme = f.read()

          with open('PROJECTS_SECTION.md', 'r') as f:
              projects_section = f.read()

          # Insert after Quick Start section (after first ---)
          parts = readme.split('---', 2)
          if len(parts) >= 3:
              new_readme = parts[0] + '---' + parts[1] + '---\n\n' + projects_section + '\n---' + '---'.join(parts[2:])
          else:
              new_readme = readme + '\n\n' + projects_section

          with open('README.md', 'w') as f:
              f.write(new_readme)

          print("README.md updated with new section")
          PYTHON_SCRIPT
          fi

      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add README.md

          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "docs: update projects list [automated]"
            git push
          fi
